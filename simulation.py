import subprocess
import requests
import time
import json
import sys
from concurrent.futures import ThreadPoolExecutor, as_completed
import threading
from transformers import AutoTokenizer

num_users = 25
max_concurrent = 25

times = []
tokens = []

# Load tokenizer
model_id = "gaunernst/gemma-3-27b-it-int4-awq"
tokenizer = AutoTokenizer.from_pretrained(model_id, trust_remote_code=True)


def stream_chat(prompt, i):
    url = "http://localhost:8090/stream"
    headers = {"Content-Type": "application/json"}
    data = {
        "messages": [
            {
                "role": "user",
                "content": [
                    {"type": "text", "text": prompt},
                ]
            }
        ]
    }

    response = ""
    toks = 0
    start_time = time.time()
    with requests.post(url, headers=headers, json=data, stream=True) as r:
            for line in r.iter_lines():
                if line and line.startswith(b"data:"):
                    try:
                        chunk = json.loads(line.lstrip(b"data: ").decode("utf-8"))
                        print(f"User {i}: ", chunk['choices'][0]['delta'].get('content', ''), "\n", end='', flush=True)
                        response += chunk['choices'][0]['delta'].get('content', '')

                        # if i == 19:
                        #     print(chunk['choices'][0]['delta'].get('content', ''), end='', flush=True)

                    except json.JSONDecodeError:
                        continue
                        
    end_time = time.time()
    duration = end_time - start_time
    times.append(duration)

    toks = len(tokenizer.encode(response))
    tokens.append(toks)

    print(f"User {i} finished in {duration:.2f} seconds, {toks/duration} T/s \n", end='', flush=True)



    with open(f"/workspace/User{i}.txt", "w") as f:
        f.write(f"\n{response} \n")
        f.write(f"⏱️ Took {duration:.2f} seconds \n")
        f.write(f"Number of tokens: {str(toks)} \n")
        f.write(f"T/s: {str(toks/duration)}")


def plot_durations(times, tokens, filename1="/workspace/durations.png", filename2="/workspace/speed.png"):
    import matplotlib.pyplot as plt
    import numpy as np
    x_labels = [f"User {i}" for i in range(len(times))]  

    plt.bar(x_labels, times)
    plt.xlabel("User")
    plt.ylabel("Time (seconds) to output")
    plt.title("Generation Duration for {num_users} Users, {max_concurrent} Simultaneously")
    plt.savefig(filename1)
    print(f"Average duration for {num_users} users, {max_concurrent} simultaneously:: {np.mean(times)}")

    rates = [t / s for t, s in zip(tokens, times)]
    plt.bar(x_labels, rates)
    plt.xlabel("User")
    plt.ylabel("t/s")
    plt.title(f"Generation Speed for {num_users} Users, {max_concurrent} Simultaneously")
    plt.savefig(filename2)
    print(f"Plot saved as {filename2}")
    print(f"Average T/s for {num_users} users, {max_concurrent} simultaneously: {np.mean(tokens)/np.mean(times)}")




# Entry point when run from terminal
if __name__ == "__main__":

    
    prompt = """  תסכם בבקשה את הכתבה הבאה:

ברשת חושדים: זו הדרך המוזרה שבה טראמפ באמת חישב את המכסים שלו
הנוסחה המקורית שבה חושבו לכאורה המכסים שהטיל טראמפ הפתיעה את הכלכלנים שלא מבינים את ההיגיון שבה • כעת טוענים ברשת כי הנוסחה בכלל לא חושבה - אלא התקבלה מצ'טבוט חכם בסגנון chatGPT או גרוק של אילון מאסק • ההוכחה: זו התשובה שהם הציעו כשביקשו מהם "דרך קלה" לפתור גרעונות סחר • חתן פרס נובל הכלכלן פול קרוגמן: "סקיינט יכולה להסתפק בלתת עצות גרועות על מכסים"

המכסים שהטיל טראמפ על שותפות הסחר של ארה"ב הכניסו את הכלכלה העולמית להלם. מעבר לשאלה מה עושים עכשיו, רבים העלו גבה לגבי האופן שבו חושב גובה המכס הספציפי שהוטל על כל מדינה ומדינה. תיאוריה שרצה ברשת בימים שחלפו שמאז "יום השחרור" של טראמפ מעלה סברה מעניינת - הסיבה שכלכלנים מתקשים להבין את ההיגיון מאחורי המספרים היא שאין היגיון: הם יוצרו על ידי צ'טבוט בינה מלאכותית כמו ChatGPT או גרוק של אילון מאסק.
כשטראמפ הציג את מדיניות הסחר החדשה הוא נופף בשלט קרטון גדול עם הכותרת "מכסים הדדיים". הנשיא הכריז על מכס בסיסי של 10% על כל היבוא לארה"ב, כולל מאיים לא מיושבים, בנוסף לשיעורים גבוהים במיוחד על מדינות מסוימות. כך, על סין הוטל מכס נוסף של 34%, על האיחוד האירופי 20% ועל ויטנאם 46%.
הכלכלן ג'יימס סורוביאקי מצא שניתן לשחזר את המספרים של הבית הלבן באמצעות נוסחה פשוטה: לקחת את הגירעון המסחרי של ארה"ב מול מדינה מסוימת ולחלק אותו בסך היצוא של אותה מדינה לארה"ב. אם מחלקים את התוצאה בשתיים, מקבלים מספר שדומה מאד לאותו "מכס הדדי מופחת" של טראמפ. בבית הלבן הכחישו את ההאשמות הללו וטענו כי פיתחו נוסחה משלהם, אך לפי דיווחים זו בסך הכל גירסה מפונפנת של החישוב של סורוביאקי.
על ישראל הוטל מכס בשיעור של 17% - מורכב מ-10% בסיסי ו-7% ייעודי. לפי בכירים באוצר, החישוב נעשה בדיוק לפי הנוסחה המדוברת: הממשל האמריקאי לקח את הגירעון המסחרי של ארה"ב מול ישראל (כ-7 מיליארד דולר) וחילק אותו בסך הייצוא של ישראל לארה"ב (כ-20 מיליארד דולר). התוצאה היא בערך 33%. הממשל האמריקני חילק את התוצאה הזו בשתיים, וכך הגיע למכס של כ-17%.
סורוביאקי כינה את הגישה הזו "שטות מוחלטת". אבל מה שהפתיע רבים היה הגילוי שמספר צ'טבוטים מציעים בדיוק את אותה נוסחה כאשר שואלים אותם על דרך קלה לפתור גירעונות סחר.
דימיון מפתיע לתשובות הבוטים
אתר הטכנולוגיה ה-Verge דיווח כי מספר משתמשים ברשת החברתית אקס (טוויטר לשעבר) גילו שאם שואלים את הצ'טבוטים על "דרך קלה" לפתור גירעונות סחר ולשים את ארה"ב על "מגרש משחקים שווה" - הם מציעים את נוסחת "הגירעון חלקי היצוא" באופן עקבי ומפתיע.
ב-Verge בדקו את הטענות: הם שאלו ארבע מערכות בינה מלאכותית מובילות - ChatGPT, ג'מיני, קלוד וגרוק - כיצד לחשב מכסים שיאזנו את הגירעון המסחרי של ארה"ב. כל ארבע המערכות הציעו את אותה נוסחה בסיסית: לקחת את הגירעון המסחרי ולחלק אותו בסך היצוא.
לפי ה-Verge ישנם הבדלים קטנים בין התשובות. גרוק וקלוד הציעו במפורש לחלק את התוצאה בשתיים כדי ליצור מה שגרוק כינה תוצאה "סבירה" - בדיוק כמו רעיון ה"הנחה" של טראמפ. כששואלים על מכס בסיסי של 10%, המערכות גם חלוקות בשאלה האם יש להוסיף אותו לשיעור המכס הכולל או לא.
"סקיינט לא צריכה לפתוח מלחמה"
פרשן הניו יורק טיימס עזרא קליין העלה את התיאוריה על שימוש בצ'טבוט לחישוב המכסים בראיון שערך בפודקאסט שלו עם הכלכלן חתן פרס נובל פרופ' פול קרוגמן. קליין ציין שאם שואלים את תוכנות הבינה המלאכותית המובילות כמו ChatGPT, ג'מיני וקלוד איך לחשב מכסים על מדינות אחרות, הן מציעות בדיוק את אותו חישוב כמו זה שהציג טראמפ.
קרוגמן הגיב בהומור: "סקיינט לא צריכה לפתוח במלחמה גרעינית. מספיק שתיתן עצות גרועות למכסים". הוא הוסיף שאין אף מאמר כלכלי מקצועי שממליץ על חישוב כזה. "זה פשוט לא משהו שהיית ממליץ עליו אם אתה מבין משהו על איך סחר עובד", הסביר.
לדבריו, הצ'טבוטים מציגים מידע שמצאו ברשת בלי יכולת אמיתית להבחין בין מה שהגיוני למה שלא, וזו בדיוק הסיבה שהמלצה כזו "היא יותר סיפור אזהרה על בינה מלאכותית מאשר משהו על כלכלה".
אפילו הצ'טבוטים הזהירו
ה-Verge דיווח שהצ'טבוטים אמנם הציעו את הנוסחה הפשוטה, אך חלקם גם הוסיפו אזהרות שונות. ג'מיני, למשל, היה הנחרץ ביותר והציג עמוד שלם של הסברים לפיהם מדובר בגישה פשטנית שעתידה להיכשל: "בעוד שחישוב זה מציע דרך פשוטה לכאורה להתמודד עם גירעונות סחר דו-צדדיים, ההשלכות הכלכליות בעולם האמיתי מורכבות הרבה יותר ועלולות להוביל לתוצאות שליליות משמעותיות", הזהיר הצ'טבוט.
ג'מיני אף הוסיף ש"כלכלנים רבים טוענים שמכסים אינם כלי יעיל לאיזון גירעונות סחר" - אזהרה שנראה כי נעלמה מעיני מקבלי ההחלטות.

יותר מ-5 טריליון דולר התאדו
 
עבור בורסות וול סטריט השבוע שעבר היה השבוע הגרוע ביותר שלהן מאז משבר הקורונה. מדד S&P 500 איבד 9.1% מערכו במהלך השבוע, לאחר שצנח ב-6% ביום שישי ו-4.8% ביום חמישי. הירידות החדות לאחר שטראמפ חשף את גובה המכסים, נמחקו כ-5.4 טריליון דולר משווי השוק של החברות במדד ה-S&P 500.
מדד הדאו ג'ונס צנח ביום שישי ב-5.5% ואיבד 2,231 נקודות ביום אחד - הפעם הראשונה בהיסטוריה שהמדד מאבד יותר מ-1,500 נקודות ביומיים רצופים. מדד הנאסד"ק מוטה מניות הטכנולוגיה צנח ביותר מ-20% מאז השיא שרשם בדצמבר - שיעור שמכונה כניסה לשוק דובי, המתאר ירידה חדה ומתמשכת.
המניות שנפגעות במיוחד
את הירידות בבורסה מובילה חברת השבבים טאוואר, שצונחת בקרוב ל-12%. טבע יורדת כ-6.3% אף שתרופות כרגע פטורות מהמכסים החדשים שהטיל טראמפ. מניות הבנקים מאבדות גם הן שיעורים ניכרים: בנק הפועלים ובנק לאומי יורדים שניהם סביב 4.7% ומזרחי טפחות משיל כ-2.7%.
"הבורסה בתל אביב מגיבה לאירוע חיצוני, בניגוד למשברים פנימיים שידענו בשנים האחרונות", מסר הבוקר יניב פגוט, סמנכ"ל המסחר בבורסה. "ההשפעה ניכרת בעיקר דרך מניות דואליות וירידה בתיאבון הסיכון. מי שסבור שמדובר באירוע מתמשך עם השלכות מיתון עולמיות, יבחר לשנות את תיק ההשקעות שלו.
"חשוב לזכור שמדובר בהחלטות של הנשיא טראמפ שהוא יכול להפוך במהירות – במיוחד בעידן בו אמירה אחת של מנהיג עשויה לשנות את כיוון השווקים. אם תתפתח מלחמת סחר כוללת, נצפה לעוד תגובות – בעיקר מהצד האירופי. בטווח הקצר נראה עלייה במחירים, קושי בהפחתת ריבית, ולחצים פוליטיים להמשך התמריצים".  
    """


    
    with ThreadPoolExecutor(max_workers=max_concurrent) as executor:
        start_time = time.time()
        futures = [
            executor.submit(stream_chat, prompt, i)
            for i in range(num_users)
        ]
        for future in as_completed(futures):
            future.result()

    print("All threads done.")

    plot_durations(times, tokens)
